# 第六章：自定义GUI框架（`cvs`包）

在[第五章：GUI向导（触摸拖拽UI设计）](05_gui_wizard__touch_and_drag_ui_design_.md)中，我们学习了如何通过"触摸拖拽"的方式可视化设计应用界面

这是快速布局按钮和标签的绝佳方法！但有时我们需要更多控制。比如：

*   让按钮执行向导未提供的特定功能？
*   在应用中显示实时摄像头画面，并让AI实时分析？
*   直接在应用中的图像或视频帧上绘制自定义形状或文本？

这时，由AidLearning的**`cvs`包**驱动的**自定义GUI框架**就派上用场了。它让我们能够编写Python代码，直接在安卓设备上构建高度交互的动态图形用户界面(GUI)，并与AI和计算机视觉任务完美集成。

## 什么是`cvs`包？我们的高级GUI工具包

可以把`cvs`包看作AidLearning的专用工具包，用于通过Python构建强大的应用。它专为在安卓手机上无缝结合交互式视觉（`GUI`）和图像/视频处理（`计算机视觉`）任务而设计。

它的独特之处在于：
*   **专为AidLearning定制**：专为AidLearning环境开发，在移动设备上高效易用。
*   **强强联合**：巧妙扩展了两个流行的Python库：
    *   **OpenCV（`cv2`）**：广泛用于计算机视觉，让程序能"看到"并处理图像和视频。
    *   **`remi`（Python REMote Interface）**：帮助用Python创建基于Web的GUI。
*   **安卓交互性**：可以设计带有按钮、文本字段、图像甚至实时视频流的应用，像原生移动应用一样响应触摸。

因此，`cvs`包是我们构建复杂AI应用的桥梁，不仅执行智能计算，还能通过视觉界面与用户优雅交互，全部用Python在安卓设备上编码实现。

## 为什么用`cvs`构建自定义GUI？

GUI向导适合静态布局，而`cvs`让我们能够应对动态复杂场景：
1.  **完全控制**：编写代码，精确控制每个像素和交互。
2.  **深度AI集成**：专为与计算机视觉协同工作设计。比如构建一个在实时摄像头画面中检测人脸并绘制框的应用——`cvs`让这变得简单。
3.  **独特移动功能**：针对移动环境优化，有效利用手机摄像头和触摸屏。

让我们探索如何使用这个强大框架！

## `cvs`工具包：核心组件

用`cvs`构建GUI通常需要以下主要部分：

*   **`import cvs`**：将整个`cvs`库导入Python脚本。
*   **`from remi import gui`**：通常从`remi`导入`gui`（`cvs`已集成）以获取基本UI组件，如`Label`、`Button`、`VBox`（垂直排列）等。
*   **`App`类**：通过从`cvs.App`（源自`remi`）继承定义主应用类，包含应用逻辑和结构。
*   **`main()`方法**：在`App`类中，这个特殊方法用于创建和排列所有UI元素，必须`return` GUI的主（根）部分。
*   **`initcv()`和`startcv()`**：在脚本末尾调用这两个函数，初始化AidLearning的GUI系统并启动应用。

从一个简单示例开始。

### 1. 第一个`cvs` GUI："你好AidLearning！"

创建一个仅显示"你好AidLearning！"的简单应用。

```python
from cvs import * # 导入主cvs包

class MyHelloApp(App): # 从cvs.App继承的应用类
    def __init__(self, *args):
        super(MyHelloApp, self).__init__(*args)

    def main(self): # 构建UI的main方法
        # 创建Label部件显示文本
        hello_label = gui.Label("你好AidLearning世界！", width=200, height=50)
        
        # 返回应用的主部件
        return hello_label

if __name__ == '__main__':
    # 初始化GUI窗口系统
    initcv(cvs.openwin)
    # 启动GUI应用
    startcv(MyHelloApp)
```
**代码功能：**
1.  `from cvs import *`：从`cvs`包导入所有内容。
2.  `class MyHelloApp(App):`：定义应用。`App`是`cvs`（通过`remi`）提供的GUI应用基类。
3.  `main()`：创建`gui.Label`（文本显示部件）并设置文本。
4.  `return hello_label`：`main`方法必须返回代表应用界面的主部件。
5.  `initcv(cvs.openwin)`：准备AidLearning为应用打开图形窗口。
6.  `startcv(MyHelloApp)`：在窗口中启动`MyHelloApp`应用。

在Aid_code中运行此脚本，安卓屏幕上会出现新窗口，显示"你好AidLearning世界！"。

### 2. 添加交互按钮

现在通过添加按钮让应用更交互，点击按钮改变标签文本。

```python
from cvs import *

class MyInteractiveApp(App):
    def __init__(self, *args):
        super(MyInteractiveApp, self).__init__(*args)

    def main(self):
        # 创建垂直容器存放部件
        container = gui.VBox(width=300, height=200, style={'margin':'0px auto'})
        
        # 创建标签
        self.message_label = gui.Label('点击按钮！')
        
        # 创建按钮
        action_button = gui.Button('点我！')

        # 连接按钮点击事件到函数
        action_button.onclick.do(self.on_button_pressed)

        # 将标签和按钮添加到容器
        container.append(self.message_label)
        container.append(action_button)

        return container

    # 按钮按下时运行的函数
    def on_button_pressed(self, widget):
        self.message_label.set_text('按钮被点击了！')
        print("控制台中显示按钮被按下！") # 在AidLearning控制台中显示

if __name__ == '__main__':
    initcv(cvs.openwin)
    startcv(MyInteractiveApp)
```
**代码功能：**
1.  `gui.VBox`：创建垂直布局盒子，便于部件垂直堆叠。
2.  `self.message_label`：将标签存储为`self.message_label`，便于后续从其他函数修改文本。
3.  `action_button.onclick.do(self.on_button_pressed)`：告诉部件事件发生时执行什么操作。这里点击`action_button`时调用`on_button_pressed`函数。
4.  `on_button_pressed(self, widget)`：按钮点击触发此函数，修改`self.message_label`文本并在控制台打印消息。

运行后看到标签和按钮。点击按钮，标签文本神奇变化！

### 3. 结合GUI与计算机视觉：实时摄像头画面！

这是`cvs`真正闪耀之处！可以将实时摄像头处理（使用`cv2`函数）直接集成到GUI应用中。通常将GUI设置与持续图像处理分开。

```python
from cvs import *
import numpy as np # 如需图像处理

class MyCameraApp(App):
    def __init__(self, *args):
        super(MyCameraApp, self).__init__(*args)
        
    def main(self):
        # 创建摄像头视图容器
        main_container = gui.VBox(width=360, height=680, style={'margin':'0px auto'})
        
        # 特殊部件显示OpenCV视频/图像
        self.camera_display = OpencvVideoWidget(self, width=340, height=480)
        self.camera_display.style['margin'] = '10px'
        
        # 设置标识符，cvs.imshow知道发送帧到哪里
        self.camera_display.set_identifier("my_live_camera_feed")
        main_container.append(self.camera_display)

        return main_container
        
# 此函数在单独线程中处理摄像头
def process_camera_feed():
    # 打开摄像头（1通常是前置，0是后置）
    camera_capture = cvs.VideoCapture(1) 

    while True:
        # 短暂暂停（类似cv2.waitKey）
        cvs.sleep(30) 
        
        # 从摄像头读取一帧
        frame = camera_capture.read()
        
        if frame is None:
            continue
        
        # 可在此进行AI处理！如人脸检测、物体识别。
        # 现在仅在帧上画红色圆
        center_x, center_y = frame.shape[1] // 2, frame.shape[0] // 2
        cvs.circle(frame, (center_x, center_y), 50, (0, 0, 255), 3) # 红色圆
        
        # 在OpencvVideoWidget上显示处理后的帧
        cvs.imshow(frame, "my_live_camera_feed")

if __name__ == '__main__':
    # 初始化GUI并运行摄像头处理函数
    initcv(process_camera_feed)
    # 启动GUI应用
    startcv(MyCameraApp)
```
**代码功能：**
1.  **`MyCameraApp`（GUI部分）**：
    *   创建`gui.VBox`容器。
    *   `OpencvVideoWidget(self, ...)`：关键的`cvs`专用部件，创建显示OpenCV实时视频/图像的GUI区域。
    *   `self.camera_display.set_identifier("my_live_camera_feed")`：为视频显示部件设置唯一名称，处理函数知道*在哪里*显示帧。
2.  **`process_camera_feed()`（视觉部分）**：
    *   这是与主GUI分离的常规Python函数。
    *   `cvs.VideoCapture(1)`：打开手机摄像头。可能需要尝试`0`或`1`选择前后摄像头。
    *   `cvs.sleep(30)`：暂停30毫秒，让GUI更新，避免循环占用所有处理资源。类似`cv2.waitKey(30)`。
    *   `camera_capture.read()`：从摄像头获取一帧（图片）。
    *   `cvs.circle(...)`：使用标准OpenCV函数（通过`cvs`可用）在实时摄像头帧中心画红色圆，展示图像处理能力。
    *   `cvs.imshow(frame, "my_live_camera_feed")`：将处理后的`frame`发送到标识符为`"my_live_camera_feed"`的`OpencvVideoWidget`显示。
3.  **`initcv(process_camera_feed)`**：不同于`cvs.openwin`，直接将`process_camera_feed`函数传给`initcv`，告诉AidLearning在后台线程中持续获取和处理摄像头帧。
4.  **`startcv(MyCameraApp)`**：启动应用的视觉部分（`MyCameraApp`）。

运行后，手机摄像头画面实时显示在屏幕上，中央有一个红色圆！这是构建高级AI视觉应用的基础。

## `cvs`的底层工作原理

`cvs`包像智能桥梁，连接基于Web的GUI（`remi`）与强大的计算机视觉（`OpenCV`），并优化以在AidLearning的[安卓Linux环境](04_linux_environment_on_android_.md)中流畅运行。

以下是`cvs`应用运行时的简化流程：

```mermaid
sequenceDiagram
    participant 用户
    participant AidLearning应用
    participant 我们的Python应用（使用cvs）
    participant cvs包
    participant 底层库（remi, OpenCV, Android API）
    participant 手机硬件（摄像头, 屏幕）

    用户->>AidLearning应用: 启动AidLearning应用
    AidLearning应用->>我们的Python应用（使用cvs）: 启动脚本
    我们的Python应用（使用cvs）->>cvs包: 创建UI元素（标签, 按钮, OpencvVideoWidget）
    cvs包->>底层库: 调用remi构建Web UI结构
    cvs包->>手机硬件（摄像头, 屏幕）: 请求初始显示UI元素

    loop 持续摄像头处理（如`process_camera_feed`）
        我们的Python应用（使用cvs）->>cvs包: 调用cvs.VideoCapture().read()
        cvs包->>底层库: 通过OpenCV访问Android摄像头API
        底层库->>手机硬件（摄像头, 屏幕）: 捕获一帧
        手机硬件（摄像头, 屏幕）-->>底层库: 返回摄像头帧数据
        底层库-->>cvs包: 将帧传递给cvs
        我们的Python应用（使用cvs）->>cvs包: 调用cvs.imshow(frame, "my_live_camera_feed")
        cvs包->>底层库: 将帧发送到特定OpencvVideoWidget
        底层库->>手机硬件（摄像头, 屏幕）: 更新屏幕上显示的视频
    end

    用户->>AidLearning应用: 与UI交互（如点击按钮）
    AidLearning应用->>我们的Python应用（使用cvs）: 触发onclick事件
    我们的Python应用（使用cvs）->>cvs包: 执行事件处理函数
    我们的Python应用（使用cvs）-->>用户: 根据交互更新UI
```

可见，`cvs`是核心组件。它理解Python命令，将其转化为`remi`构建视觉元素的动作，以及`OpenCV`与摄像头交互和处理图像的动作，然后高效显示在手机屏幕上。

### 重要`cvs`函数速查

`cvs`包提供了许多来自`OpenCV`和`remi`的函数，以及一些自定义函数。以下是常用部分：

| 函数/变量                                                | 类别            | 用途（简化）                                                 |
| :------------------------------------------------------- | :-------------- | :----------------------------------------------------------- |
| `App`                                                    | `cvs` / `remi`  | 整个GUI应用的基类。                                          |
| `gui`                                                    | `remi`          | 包含标准UI部件（`Label`、`Button`、`VBox`等）的模块。        |
| `initcv(func)`                                           | `cvs`（自定义） | 初始化GUI系统。`func`在后台运行处理任务。                    |
| `startcv(AppClass)`                                      | `cvs` / `remi`  | 启动主GUI应用。                                              |
| `openwin`                                                | `cvs`（自定义） | 传递给`initcv`的默认函数，用于简单GUI设置。                  |
| `VideoCapture(id)`                                       | `cvs` / `cv2`   | 打开摄像头流（如`0`后置，`1`前置）。                         |
| `read()`                                                 | `cvs` / `cv2`   | 从打开的摄像头/视频读取一帧。                                |
| `imshow(image, id)`                                      | `cvs` / `cv2`   | 在GUI上显示图像/帧，可选发送到特定`OpencvVideoWidget`的`id`。 |
| `circle(img, center, radius, color, thickness)`          | `cvs` / `cv2`   | 在图像上画圆。                                               |
| `putText(img, text, org, font, scale, color, thickness)` | `cvs` / `cv2`   | 在图像上绘制文本。                                           |
| `sleep(ms)`                                              | `cvs`（自定义） | 暂停执行指定毫秒数。                                         |
| `OpencvVideoWidget`                                      | `cvs`（自定义） | 显示OpenCV实时视频/图像的专用GUI部件。                       |

更多详细信息和示例可在AidLearning项目的`gui_cvs/README.md`文件中找到，其中突出显示了通过`cvs`包直接可用的许多`cv2`函数。

## 总结

本章探索了AidLearning强大的**`cvs`包**提供的**自定义GUI框架**。我们了解到`cvs`是一个专用Python库，融合了`OpenCV`（计算机视觉）和`remi`（Web GUI）的能力，让我们能在安卓设备上用Python构建交互式应用。学习了如何创建基础GUI、处理按钮点击，以及最激动人心的——将实时摄像头画面和图像处理集成到应用中。这个高级工具包赋予我们终极控制权，在移动设备上用Python代码实现AI和视觉项目创意。

接下来，我们将探索如何轻松连接AidLearning环境到PC，实现更舒适的编码、远程访问和便捷文件管理。

[下一章：PC连接（SSH与Web）](07_pc_connectivity__ssh___web__.md)

