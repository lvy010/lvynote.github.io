# ç¬¬2ç« ï¼šä¸»åŠ¨ç”»ç®¡çº¿

æ¬¢è¿å›æ¥

åœ¨[ç¬¬1ç« ï¼šGradioç”¨æˆ·ç•Œé¢](01_gradio_user_interface_.md)ä¸­ï¼Œæˆ‘ä»¬æ¢ç´¢äº†æ— éœ€ç¼–ç å³å¯æ“ä½œLivePortraitçš„å‹å¥½"æ§åˆ¶é¢æ¿"ï¼Œäº†è§£äº†`GradioPipeline`å¦‚ä½•ä½œä¸ºè§£é‡Šå™¨å°†ç‚¹å‡»å’Œä¸Šä¼ æ“ä½œè½¬æ¢ä¸ºæŒ‡ä»¤ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ­å¼€æ§åˆ¶é¢æ¿çš„é¢çº±ï¼Œæ¢ç´¢å®ç°é­”æ³•çš„æ ¸å¿ƒ"å¼•æ“"â€”â€”**==ä¸»åŠ¨ç”»ç®¡çº¿==**ã€‚è¿™æ˜¯å°†æºå›¾åƒä¸é©±åŠ¨åŠ¨ä½œé€æ­¥è½¬åŒ–ä¸ºç”ŸåŠ¨åŠ¨ç”»çš„æ ¸å¿ƒåè°ƒå™¨

## å¼•æ“å®¤ï¼šä¸»åŠ¨ç”»ç®¡çº¿çš„åŠŸèƒ½

æƒ³è±¡ä½ åœ¨çƒ˜ç„™å¤æ‚è›‹ç³•ã€‚

Gradioç•Œé¢å°±åƒé£Ÿè°±ä¹¦ï¼Œè®©ä½ é€‰æ‹©é£Ÿæå’Œè®¾ç½®ã€‚è€Œ**ä¸»åŠ¨ç”»ç®¡çº¿**å°±æ˜¯å®é™…çš„çƒ˜ç„™è¿‡ç¨‹â€”â€”æŒ‰ç…§ç²¾ç¡®æ­¥éª¤æ··åˆé£Ÿæã€çƒ˜ç„™å’Œè£…é¥°ã€‚

ä¸»åŠ¨ç”»ç®¡çº¿çš„æ ¸å¿ƒèŒè´£åŒ…æ‹¬ï¼š
1. **åŠ è½½è¾“å…¥**ï¼šå¯¼å…¥æºå›¾åƒ/è§†é¢‘å’Œé©±åŠ¨è§†é¢‘/æ¨¡æ¿
2. **æ•°æ®å‡†å¤‡**ï¼šæ™ºèƒ½è£å‰ªäººè„¸ï¼ˆæˆ–åŠ¨ç‰©ï¼ï¼‰å¹¶æ£€æµ‹å…³é”®é¢éƒ¨ç‰¹å¾ç‚¹ï¼ˆç§°ä¸º"å…³é”®ç‚¹"ï¼‰
3. **æå–åŠ¨ä½œ**ï¼šè§£æé©±åŠ¨è§†é¢‘ä¸­ä¸»ä½“çš„å¤´éƒ¨ã€çœ¼ç›å’Œå˜´å”‡è¿åŠ¨
4. **åŠ¨ç”»ç”Ÿæˆ**ï¼šä½¿ç”¨å¼ºå¤§AIæ¨¡å‹å°†åŠ¨ä½œä»é©±åŠ¨ä¸»ä½“è¿ç§»åˆ°é™æ€æºå›¾åƒ
5. **è¾“å‡ºç”Ÿæˆ**ï¼šå°†æ‰€æœ‰åŠ¨ç”»å¸§ç»„åˆæˆæœ€ç»ˆè§†é¢‘æˆ–å›¾åƒ

LivePortraitæœ‰ä¸¤æ¡ä¸»è¦ç®¡çº¿ï¼Œ==åˆ†åˆ«é’ˆå¯¹ä¸åŒä¸»ä½“ä¼˜åŒ–==ï¼š
* `LivePortraitPipeline`ï¼ˆ==äººåƒ==ï¼‰
* `LivePortraitPipelineAnimal`ï¼ˆ==åŠ¨ç‰©==ï¼‰

ä¸¤è€…éµå¾ªç›¸ä¼¼"é…æ–¹"ï¼Œä½†ä½¿ç”¨==é’ˆå¯¹ç‰¹å®šä»»åŠ¡ä¼˜åŒ–çš„ä¸åŒå†…éƒ¨å·¥å…·==ã€‚

## é¦–æ¬¡åŠ¨ç”»åˆ¶ä½œï¼šä½¿ç”¨ç®¡çº¿

è‹¥é€šè¿‡Gradioç•Œé¢ä½¿ç”¨LivePortraitï¼Œæ— éœ€ç›´æ¥è°ƒç”¨`LivePortraitPipeline`â€”â€”å¦‚ç¬¬1ç« æ‰€è¿°ï¼Œ`GradioPipeline`å·²ä»£ä¸ºå¤„ç†ï¼

ä½†è‹¥æƒ³è„±ç¦»ç½‘é¡µç•Œé¢è¿è¡Œï¼ˆä¾‹å¦‚åœ¨è„šæœ¬ä¸­ï¼‰ï¼Œéœ€ä½¿ç”¨"å…¥å£"è„šæœ¬ï¼šäººåƒç”¨`inference.py`ï¼ŒåŠ¨ç‰©ç”¨`inference_animals.py`ã€‚è¿™äº›è„šæœ¬ç›´æ¥åˆå§‹åŒ–å’Œè¿è¡Œç›¸åº”ç®¡çº¿ã€‚

ä»¥ä¸‹æ˜¯`inference.py`çš„ç®€åŒ–ç¤ºä¾‹ï¼Œå±•ç¤º`LivePortraitPipeline`çš„è°ƒç”¨æ–¹å¼ï¼š

```python
# --- ç®€åŒ–çš„inference.pyä»£ç ç‰‡æ®µ ---
import tyro
from src.config.argument_config import ArgumentConfig
from src.config.inference_config import InferenceConfig
from src.config.crop_config import CropConfig
from src.live_portrait_pipeline import LivePortraitPipeline # äººåƒä¸»ç®¡çº¿ï¼

def main():
    # 1. æ”¶é›†æ‰€æœ‰è®¾ç½®ï¼ˆå¦‚æºå›¾åƒè·¯å¾„ã€é©±åŠ¨è§†é¢‘è·¯å¾„ï¼‰
    args = tyro.cli(ArgumentConfig)

    # 2. å‡†å¤‡ç‰¹å®šé…ç½®å¯¹è±¡
    inference_cfg = InferenceConfig() # ç®€åŒ–ç‰ˆï¼Œå®é™…ä»£ç ä½¿ç”¨partial_fields
    crop_cfg = CropConfig()

    # 3. åˆ›å»ºåŠ¨ç”»å¼•æ“å®ä¾‹ï¼
    live_portrait_pipeline = LivePortraitPipeline(
        inference_cfg=inference_cfg,
        crop_cfg=crop_cfg
    )

    # 4. å¯åŠ¨åŠ¨ç”»ç”Ÿæˆï¼
    live_portrait_pipeline.execute(args)

if __name__ == "__main__":
    main()
```
**è¯´æ˜**ï¼š
1. è„šæœ¬é¦–å…ˆå°†æ‰€æœ‰è®¾ç½®ï¼ˆæºå›¾åƒã€é©±åŠ¨è§†é¢‘ã€è´¨é‡ç­‰ï¼‰æ”¶é›†åˆ°`args`å¯¹è±¡
2. å‡†å¤‡`InferenceConfig`å’Œ`CropConfig`å¯¹è±¡ï¼Œè¿™äº›æ˜¯ç®¡çº¿ä¸åŒéƒ¨åˆ†çš„è¯¦ç»†æŒ‡ä»¤è¡¨ï¼ˆå°†åœ¨[ç¬¬3ç« ï¼šé…ç½®ç³»ç»Ÿ](03_configuration_system_.md)è¯¦è¿°ï¼‰
3. åˆ›å»º`LivePortraitPipeline`å¯¹è±¡ï¼Œç”¨åˆå§‹æŒ‡ä»¤ç»„è£…åŠ¨ç”»å¼•æ“
4. è°ƒç”¨`live_portrait_pipeline.execute(args)`â€”â€”è¿™æ˜¯å¯åŠ¨æ•´ä¸ªåŠ¨ç”»è¿‡ç¨‹çš„**æ ¸å¿ƒå‘½ä»¤**ï¼Œå¦‚åŒæŒ‰ä¸‹å¤æ‚æœºå™¨çš„"å¯åŠ¨"æŒ‰é’®

`inference_animals.py`è„šæœ¬å‡ ä¹ç›¸åŒï¼Œä½†åˆå§‹åŒ–çš„æ˜¯`LivePortraitPipelineAnimal`ã€‚

## å†…éƒ¨æœºåˆ¶ï¼šé€æ­¥åŠ¨ç”»é…æ–¹

å½“è°ƒç”¨`live_portrait_pipeline.execute(args)`æ—¶ï¼Œå°†æ‰§è¡Œè¯¦ç»†çš„æ“ä½œåºåˆ—ï¼Œå¦‚åŒéµå¾ªé£Ÿè°±ï¼š

```mermaid
sequenceDiagram
    participant GradioPipeline
    participant LivePortraitPipeline
    participant Cropper
    participant LivePortraitWrapper
    participant è¾“å‡ºè§†é¢‘

    GradioPipeline->>LivePortraitPipeline: execute(user_args)
    Note over LivePortraitPipeline: æ­¥éª¤1ï¼šåŠ è½½è¾“å…¥
    LivePortraitPipeline->>Cropper: crop_source_image/video(æºæ•°æ®)
    Cropper-->>LivePortraitPipeline: è£å‰ªåæºæ•°æ®, æºå…³é”®ç‚¹
    LivePortraitPipeline->>Cropper: crop_driving_video(é©±åŠ¨æ•°æ®)
    Cropper-->>LivePortraitPipeline: è£å‰ªåé©±åŠ¨æ•°æ®, é©±åŠ¨å…³é”®ç‚¹
    Note over LivePortraitPipeline: æ­¥éª¤2ï¼šåˆ›å»ºåŠ¨ä½œæ¨¡æ¿
    LivePortraitPipeline->>LivePortraitWrapper: prepare_source(è£å‰ªåæº)
    LivePortraitWrapper-->>LivePortraitPipeline: æºç‰¹å¾, x_s(åŸºç¡€å…³é”®ç‚¹)
    LivePortraitPipeline->>LivePortraitWrapper: get_kp_info(è£å‰ªåé©±åŠ¨å¸§)
    LivePortraitWrapper-->>LivePortraitPipeline: é©±åŠ¨åŠ¨ä½œä¿¡æ¯
    Note over LivePortraitPipeline: æ­¥éª¤3ï¼šé€å¸§åŠ¨ç”»ç”Ÿæˆ
    loop æ¯å¸§å¾ªç¯
        LivePortraitPipeline->>LivePortraitWrapper: warp_decode(æºç‰¹å¾, x_s, å½“å‰å¸§é©±åŠ¨åŠ¨ä½œ)
        LivePortraitWrapper-->>LivePortraitPipeline: åŠ¨ç”»å¸§æ•°æ®
        LivePortraitPipeline->>è¾“å‡ºè§†é¢‘: æ·»åŠ å¸§
    end
    LivePortraitPipeline->>è¾“å‡ºè§†é¢‘: æœ€ç»ˆåŒ–è§†é¢‘ï¼ˆæ·»åŠ éŸ³é¢‘ï¼Œä¿å­˜ï¼‰
    è¾“å‡ºè§†é¢‘-->>LivePortraitPipeline: è§†é¢‘è·¯å¾„
    LivePortraitPipeline-->>GradioPipeline: åŠ¨ç”»è§†é¢‘è·¯å¾„
```

**è§£æ**ï¼š

1. **è¯·æ±‚æ¥æ”¶**ï¼š`GradioPipeline`ï¼ˆæˆ–`inference.py`ï¼‰è°ƒç”¨`LivePortraitPipeline`çš„`execute()`æ–¹æ³•ï¼Œä¼ å…¥æ‰€æœ‰ç”¨æˆ·è®¾ç½®
2. **è¾“å…¥åŠ è½½**ï¼šç®¡çº¿é¦–å…ˆä»æŒ‡å®šè·¯å¾„åŠ è½½æºå›¾åƒ/è§†é¢‘å’Œé©±åŠ¨è§†é¢‘
3. **è£å‰ªä¸å…³é”®ç‚¹æ£€æµ‹**ï¼šå°†åŸå§‹å›¾åƒ/è§†é¢‘æ•°æ®äº¤ç»™`Cropper`ï¼ˆå°†åœ¨[ç¬¬4ç« ï¼šé¢éƒ¨/å…³é”®ç‚¹è£å‰ªä¸æ£€æµ‹](04_face_keypoint_cropping___detection_.md)è¯¦è¿°ï¼‰ã€‚`Cropper`æ™ºèƒ½è¯†åˆ«äººè„¸/åŠ¨ç‰©ï¼Œè£å‰ªä¸ºæ ‡å‡†å°ºå¯¸ï¼Œå¹¶æ£€æµ‹å®šä¹‰é¢éƒ¨ç»“æ„å’Œå§¿æ€çš„"å…³é”®ç‚¹"ï¼ˆå¦‚çœ¼ç›ã€é¼»å­ã€å˜´è§’ï¼‰
4. **æå–åŠ¨ä½œæ¨¡æ¿**ï¼šåˆ©ç”¨é©±åŠ¨è§†é¢‘çš„å…³é”®ç‚¹ï¼Œç®¡çº¿åœ¨`LivePortraitWrapper`ï¼ˆ[ç¬¬5ç« ï¼šæ ¸å¿ƒæ¨¡å‹å°è£…](05_core_model_wrapper_.md)è¯¦è¿°ï¼‰ååŠ©ä¸‹åˆ›å»º"åŠ¨ä½œæ¨¡æ¿"ã€‚è¯¥æ¨¡æ¿å¦‚åŒè¯¦ç»†è„šæœ¬ï¼Œæè¿°é©±åŠ¨è§†é¢‘ä¸­çš„æ‰€æœ‰åŠ¨ä½œï¼ˆå¤´éƒ¨æ—‹è½¬ã€è¡¨æƒ…ã€çœ¨çœ¼ã€å˜´å”‡åŠ¨ä½œï¼‰ï¼Œå¯ä¿å­˜ä¸º`.pkl`æ–‡ä»¶ä¾›åç»­å¿«é€Ÿå¤ç”¨
5. **å‡†å¤‡æºç‰¹å¾**ï¼šæºå›¾åƒä¹Ÿç”±`LivePortraitWrapper`å¤„ç†ï¼Œæå–å…¶ç‹¬ç‰¹"ç‰¹å¾"å’Œåˆå§‹å…³é”®ç‚¹ä¿¡æ¯ã€‚è¿™äº›ç‰¹å¾æ˜¯æºå›¾åƒä¿æŒè‡ªèº«ç‰¹æ€§çš„å…³é”®ï¼Œå³ä½¿åŠ¨ç”»åŒ–åäº¦ç„¶
6. **åŠ¨ç”»å¾ªç¯**ï¼šæ ¸å¿ƒé­”æ³•æ‰€åœ¨ï¼ç®¡çº¿å¾ªç¯ç”Ÿæˆæ¯å¸§åŠ¨ç”»ï¼š
    * ä»é©±åŠ¨åŠ¨ä½œæ¨¡æ¿è·å–å½“å‰æ—¶åˆ»çš„"åŠ¨ä½œè„šæœ¬"
    * æ™ºèƒ½ç»“åˆé©±åŠ¨åŠ¨ä½œä¸é™æ€æºç‰¹å¾åŠå…³é”®ç‚¹
    * å°†ç»„åˆä¿¡æ¯å‘é€ç»™`LivePortraitWrapper`ç”Ÿæˆæ–°åŠ¨ç”»å¸§ï¼Œæ¶‰åŠå¤æ‚AIæ¨¡å‹å¯¹æºå›¾åƒè¿›è¡Œå½¢å˜ä»¥åŒ¹é…é©±åŠ¨åŠ¨ä½œ
7. **è¾“å‡ºæœ€ç»ˆåŒ–**ï¼šç”Ÿæˆæ‰€æœ‰å¸§åï¼Œç®¡çº¿å°†å…¶æ‹¼æ¥æˆè§†é¢‘ï¼Œå¯é€‰æ·»åŠ é©±åŠ¨æˆ–æºè§†é¢‘çš„éŸ³é¢‘ï¼Œä¿å­˜æœ€ç»ˆåŠ¨ç”»ç»“æœï¼ˆåŠæ˜¾ç¤ºæº+é©±åŠ¨+è¾“å‡ºçš„å¯¹æ¯”è§†é¢‘ï¼‰

### ğŸ¢æ¢ç´¢ï¼š`LivePortraitPipeline`ä»£ç 

yjh

æŸ¥çœ‹`src/live_portrait_pipeline.py`çš„å…³é”®éƒ¨åˆ†ï¼Œäº†è§£å¦‚ä½•å®ç°è¿™ä¸€é…æ–¹ã€‚

é¦–å…ˆï¼Œ`__init__`æ–¹æ³•è®¾ç½®ç®¡çº¿å°†ä½¿ç”¨çš„ä¸»è¦å·¥å…·ï¼š

```python
# --- ç®€åŒ–çš„src/live_portrait_pipeline.pyç‰‡æ®µï¼ˆinitæ–¹æ³•ï¼‰---
from .config.inference_config import InferenceConfig
from .config.crop_config import CropConfig
from .utils.cropper import Cropper
from .live_portrait_wrapper import LivePortraitWrapper

class LivePortraitPipeline(object):
    def __init__(self, inference_cfg: InferenceConfig, crop_cfg: CropConfig):
        # åˆå§‹åŒ–æ ¸å¿ƒAIæ¨¡å‹å¤„ç†å™¨
        self.live_portrait_wrapper: LivePortraitWrapper = LivePortraitWrapper(inference_cfg=inference_cfg)
        # åˆå§‹åŒ–é¢éƒ¨/åŠ¨ç‰©è£å‰ªå’Œå…³é”®ç‚¹æ£€æµ‹å·¥å…·
        self.cropper: Cropper = Cropper(crop_cfg=crop_cfg)
```
**è¯´æ˜**ï¼š
`LivePortraitPipeline`å……å½“ç®¡ç†è€…ï¼Œå°†å…·ä½“ä»»åŠ¡å§”æ‰˜ç»™ä¸“ç”¨å·¥å…·ï¼š
* `self.live_portrait_wrapper`ï¼šå®é™…ç”ŸæˆåŠ¨ç”»çš„æ·±åº¦å­¦ä¹ æ¨¡å‹æ¥å£
* `self.cropper`ï¼šå¤„ç†å›¾åƒ/è§†é¢‘ä¸­é¢éƒ¨/åŠ¨ç‰©çš„è¯†åˆ«å’Œå‡†å¤‡

æ¥ä¸‹æ¥ï¼Œç®€åŒ–`execute`æ–¹æ³•ä»¥çªå‡ºå…¶ä¸»è¦é˜¶æ®µï¼š

```python
# --- ç®€åŒ–çš„src/live_portrait_pipeline.pyç‰‡æ®µï¼ˆexecuteæ–¹æ³•ï¼‰---
class LivePortraitPipeline(object):
    def execute(self, args: ArgumentConfig):
        # 1. åŠ è½½æºè¾“å…¥ï¼ˆå›¾åƒæˆ–è§†é¢‘ï¼‰
        if is_image(args.source):
            source_rgb_lst = [load_image_rgb(args.source)]
        elif is_video(args.source):
            source_rgb_lst = load_video(args.source)
        # ... é©±åŠ¨è¾“å…¥ç±»ä¼¼åŠ è½½ ...

        # 2. å¤„ç†é©±åŠ¨æ•°æ®å¹¶åˆ›å»ºåŠ¨ä½œæ¨¡æ¿
        if is_template(args.driving):
            driving_template_dct = load(args.driving) # åŠ è½½é¢„åˆ¶æ¨¡æ¿
        else: # è‹¥é©±åŠ¨ä¸ºè§†é¢‘åˆ™å¤„ç†
            # ä½¿ç”¨cropperå°†é©±åŠ¨è§†é¢‘è£å‰ªä¸º256x256
            ret_d = self.cropper.crop_driving_video(driving_rgb_lst)
            driving_rgb_crop_256x256_lst = [cv2.resize(_, (256, 256)) for _ in ret_d['frame_crop_lst']]
            # å‡†å¤‡å¸§å¹¶è®¡ç®—çœ¼/å”‡æ¯”ä¾‹
            I_d_lst = self.live_portrait_wrapper.prepare_videos(driving_rgb_crop_256x256_lst)
            # ä»å‡†å¤‡å¸§åˆ›å»ºåŠ¨ä½œæ¨¡æ¿
            driving_template_dct = self.make_motion_template(I_d_lst, c_d_eyes_lst, c_d_lip_lst, output_fps=output_fps)
            dump(wfp_template, driving_template_dct) # ä¿å­˜ä¾›åç»­å¤ç”¨

        # 3. å¤„ç†æºæ•°æ®ï¼ˆè£å‰ªã€æå–ç‰¹å¾ï¼‰
        if inf_cfg.flag_do_crop:
            crop_info = self.cropper.crop_source_image(source_rgb_lst[0], self.cropper.crop_cfg)
            img_crop_256x256 = crop_info['img_crop_256x256']
        else:
            img_crop_256x256 = cv2.resize(source_rgb_lst[0], (256, 256))

        I_s = self.live_portrait_wrapper.prepare_source(img_crop_256x256)
        x_s_info = self.live_portrait_wrapper.get_kp_info(I_s)
        f_s = self.live_portrait_wrapper.extract_feature_3d(I_s)
        x_s = self.live_portrait_wrapper.transform_keypoint(x_s_info)

        # 4. ä¸»åŠ¨ç”»å¾ªç¯ï¼šé€å¸§ç”Ÿæˆ
        I_p_lst = [] # å­˜å‚¨ç”Ÿæˆå¸§çš„åˆ—è¡¨
        for i in track(range(n_frames), description='ğŸš€åŠ¨ç”»ç”Ÿæˆä¸­...', total=n_frames):
            # ä»æ¨¡æ¿è·å–å½“å‰å¸§åŠ¨ä½œä¿¡æ¯
            x_d_i_info = driving_template_dct['motion'][i]
            x_d_i_info = dct2device(x_d_i_info, device)

            # ... ç»“åˆæºç‰¹å¾å’Œé©±åŠ¨åŠ¨ä½œçš„å¤æ‚è®¡ç®— ...
            # ... ä»¥åŠåº”ç”¨é‡å®šå‘/æ‹¼æ¥é€»è¾‘ï¼ˆè‹¥å¯ç”¨ï¼‰...

            # æ ¸å¿ƒåŠ¨ç”»æ­¥éª¤ï¼šä½¿ç”¨wrapperå˜å½¢å’Œè§£ç å›¾åƒ
            out = self.live_portrait_wrapper.warp_decode(f_s, x_s, x_d_i_new)
            I_p_i = self.live_portrait_wrapper.parse_output(out['out'])[0]
            I_p_lst.append(I_p_i) # æ·»åŠ ç”Ÿæˆå¸§åˆ°åˆ—è¡¨

        # 5. ä¿å­˜å¹¶æœ€ç»ˆåŒ–è¾“å‡ºï¼ˆå¸¦æˆ–ä¸å¸¦éŸ³é¢‘çš„è§†é¢‘ã€å›¾åƒï¼‰
        mkdir(args.output_dir)
        frames_concatenated = concat_frames(driving_rgb_crop_256x256_lst, [img_crop_256x256], I_p_lst)
        images2video(frames_concatenated, wfp=wfp_concat, fps=output_fps)
        # ... æ·»åŠ éŸ³é¢‘ï¼Œä¿å­˜ç‹¬ç«‹è¾“å‡ºè§†é¢‘ ...
        return wfp, wfp_concat
```
**è¯´æ˜**ï¼š
å®é™…ä»£ç ä¸­çš„`execute`æ–¹æ³•è¾ƒé•¿ï¼Œä½†ç®€åŒ–ç‰ˆçªå‡ºäº†ä¸»è¦é˜¶æ®µï¼š
1. **è¾“å…¥åŠ è½½**ï¼šæ£€æŸ¥æºæ˜¯å›¾åƒè¿˜æ˜¯è§†é¢‘å¹¶åŠ è½½ï¼Œé©±åŠ¨è¾“å…¥åŒç†
2. **é©±åŠ¨æ•°æ®å¤„ç†ä¸åŠ¨ä½œæ¨¡æ¿**ï¼šè‹¥é©±åŠ¨è¾“å…¥ä¸ºè§†é¢‘ï¼Œä½¿ç”¨`self.cropper`å‡†å¤‡é©±åŠ¨å¸§ï¼Œè°ƒç”¨`self.make_motion_template`æå–æ‰€æœ‰å¿…è¦åŠ¨ä½œä¿¡æ¯ï¼ˆå¤´éƒ¨å§¿æ€ã€è¡¨æƒ…ç­‰ï¼‰å¹¶å­˜å…¥`driving_template_dct`ï¼Œå¯ä¿å­˜ï¼ˆ`dump`ï¼‰ä¾›å¿«é€Ÿå¤ç”¨
3. **æºæ•°æ®å¤„ç†**ï¼šè£å‰ªæºå›¾åƒ/è§†é¢‘ï¼ˆè‹¥`flag_do_crop`ä¸º`True`ï¼‰ï¼Œä½¿ç”¨`self.live_portrait_wrapper`è¿›è¡Œ`prepare_source`å’Œ`extract_feature_3d`ï¼Œè¿™å¯¹åŠ¨ç”»è¿‡ç¨‹è‡³å…³é‡è¦
4. **åŠ¨ç”»å¾ªç¯ï¼ˆ`for i in track(range(n_frames))`ï¼‰**ï¼šé€å¸§ç”Ÿæˆï¼š
    * ä»`driving_template_dct`è·å–å½“å‰æ—¶åˆ»çš„ç‰¹å®šåŠ¨ä½œ
    * æ‰§è¡Œå¤æ‚è®¡ç®—ä»¥æ··åˆæºç‰¹å¾ä¸é©±åŠ¨åŠ¨ä½œï¼Œå¯èƒ½è°ƒæ•´çœ¼/å”‡é‡å®šå‘æˆ–æ‹¼æ¥ï¼ˆåç»­ç« èŠ‚è®¨è®ºï¼‰
    * è°ƒç”¨`self.live_portrait_wrapper.warp_decode`â€”â€”å®é™…*ç”Ÿæˆ*æ–°åŠ¨ç”»å›¾åƒçš„æ ¸å¿ƒAIæ¨¡å‹è°ƒç”¨
    * å°†æ–°ç”Ÿæˆå¸§ï¼ˆ`I_p_i`ï¼‰åŠ å…¥åˆ—è¡¨
5. **è¾“å‡ºä¿å­˜**ï¼šç”Ÿæˆæ‰€æœ‰å¸§åï¼Œç®¡çº¿å°†åŠ¨ç”»å¸§åˆ—è¡¨ä¸æºå’Œé©±åŠ¨è¾“å…¥æ‹¼æ¥å¯¹æ¯”ï¼Œä¿å­˜ä¸ºè§†é¢‘æ–‡ä»¶ï¼ˆ`images2video`ï¼‰ï¼Œå¹¶å¤„ç†éŸ³é¢‘æ·»åŠ ï¼ˆè‹¥å¯ç”¨ï¼‰

### äººåƒä¸åŠ¨ç‰©åŠ¨ç”»ç®¡çº¿å¯¹æ¯”

å°½ç®¡äººåƒå’ŒåŠ¨ç‰©ç®¡çº¿æ‰§è¡Œç›¸ä¼¼çš„åè°ƒä»»åŠ¡ï¼Œä½†ç”±äºé¢éƒ¨ç‰¹å¾å·®å¼‚ï¼Œå®ƒä»¬ä½¿ç”¨ç•¥æœ‰ä¸åŒçš„åº•å±‚å·¥å…·ã€‚

| ç‰¹æ€§            | `LivePortraitPipeline`ï¼ˆäººåƒï¼‰ | `LivePortraitPipelineAnimal`ï¼ˆåŠ¨ç‰©ï¼‰ |
| :-------------- | :----------------------------- | :----------------------------------- |
| **ç›®æ ‡ä¸»ä½“**    | äººè„¸                           | åŠ¨ç‰©è„¸ï¼ˆå¦‚çŒ«ã€ç‹—ï¼‰                   |
| **æ ¸å¿ƒå°è£…å™¨**  | `LivePortraitWrapper`          | `LivePortraitWrapperAnimal`          |
| **è£å‰ªå™¨è®¾ç½®**  | `Cropper()`ï¼ˆé»˜è®¤äººè„¸ï¼‰        | `Cropper(image_type='animal_face')`  |
| **çœ¼/å”‡é‡å®šå‘** | é’ˆå¯¹äººçœ¼/å”‡æ§åˆ¶çš„ç‰¹å®šé€»è¾‘      | é€šå¸¸æ›´ç®€å•ï¼Œçœ¼/å”‡æ§åˆ¶è¾ƒå°‘            |
| **é©±åŠ¨è¾“å…¥**    | è§†é¢‘ã€å›¾åƒæˆ–Pickleæ¨¡æ¿         | ä¸»è¦æ˜¯Pickleæ¨¡æ¿ï¼Œä¹Ÿæ”¯æŒè§†é¢‘         |

## ç»“è¯­

ç°åœ¨å·²æ­å¼€LivePortrait"==å¼•æ“==å®¤"çš„å¥¥ç§˜

`LivePortraitPipeline`ï¼ˆåŠ`LivePortraitPipelineAnimal`ï¼‰æ˜¯éµå¾ªç²¾ç¡®å¤šæ­¥é…æ–¹çš„ä¸»åè°ƒå™¨ï¼Œå°†é™æ€å›¾åƒèµ‹äºˆç”Ÿå‘½ã€‚ä»==è¾“å…¥==åŠ è½½åˆ°æ•°æ®==å‡†å¤‡==ã€åŠ¨ä½œ==æå–==ï¼Œæœ€ç»ˆåˆ©ç”¨å¼ºå¤§AIæ¨¡å‹==ç”Ÿæˆ==åŠ¨ç”»å¸§ï¼Œè¿™æ¡==ç®¡çº¿æ‰¿æ‹…äº†æ‰€æœ‰ç¹é‡å·¥ä½œ==ã€‚

æˆ‘ä»¬äº†è§£åˆ°å®ƒå°†ä»»åŠ¡å§”æ‰˜ç»™`Cropper`å’Œ`LivePortraitWrapper`ç­‰ä¸“ç”¨å·¥å…·ï¼Œä½¿æ•´ä¸ªè¿‡ç¨‹é«˜æ•ˆä¸”æ¨¡å—åŒ–ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥æŒ‡å¯¼æ•´ä¸ªè¿‡ç¨‹çš„æŒ‡ä»¤ï¼š[ç¬¬3ç« ï¼šé…ç½®ç³»ç»Ÿ](03_configuration_system_.md)ã€‚

