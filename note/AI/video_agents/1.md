# ç¬¬ 1 ç« ï¼šä¼šè¯ç®¡ç†

æ¬¢è¿æ¥åˆ° Director 

åœ¨ç¬¬ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä½¿æˆ‘ä»¬çš„ç³»ç»Ÿæ„Ÿè§‰æ™ºèƒ½ä¸”è¿ç»­ï¼š**ä¼šè¯ç®¡ç†**ã€‚

æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬æ­£åœ¨ä¸æœ‹å‹èŠå¤©ã€‚æˆ‘ä»¬ä¸ä¼šæ¯æ¬¡è¯´è¯æ—¶éƒ½é‡æ–°ä»‹ç»è‡ªå·±æˆ–è°ˆè¯ä¸»é¢˜ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬éƒ½è®°å¾—ä¸€åˆ†é’Ÿå‰ç”šè‡³æ˜¨å¤©è°ˆè®ºçš„å†…å®¹ã€‚è¿™ç§"è®°å¿†"ä½¿å¾—æµç•…ã€è‡ªç„¶çš„å¯¹è¯æˆä¸ºå¯èƒ½ã€‚

## é—®é¢˜ï¼šé—å¿˜è¿‡å»

å¦‚æœæ²¡æœ‰è®°å¿†ï¼Œä¸ç³»ç»Ÿçš„æ¯æ¬¡äº¤äº’éƒ½ä¼šåƒä¸ä¸€ä¸ªç«‹å³å¿˜è®°æˆ‘ä»¬åˆšè¯´çš„ä¸€åˆ‡çš„äººäº¤è°ˆã€‚å¦‚æœæˆ‘ä»¬é—®ï¼š"ç»™æˆ‘çœ‹æœ‰è¶£çš„çŒ«å’ªè§†é¢‘"ï¼Œç„¶åç«‹å³è·Ÿè¿›é—®ï¼š"*é‚£ä¸ª*è§†é¢‘çš„é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ"ï¼Œç³»ç»Ÿä¸ä¼šçŸ¥é“"é‚£ä¸ª"æŒ‡çš„æ˜¯ä»€ä¹ˆã€‚å®ƒä¼šå°†æˆ‘ä»¬çš„ç¬¬äºŒä¸ªè¯·æ±‚è§†ä¸ºä¸€ä¸ªå…¨æ–°çš„ã€å­¤ç«‹çš„é—®é¢˜ã€‚è¿™ä¼šå¸¦æ¥éå¸¸ä»¤äººæ²®ä¸§å’Œä½æ•ˆçš„ä½“éªŒ

## è§£å†³æ–¹æ¡ˆï¼šä¼šè¯ç®¡ç†

è¿™å°±æ˜¯ä¼šè¯ç®¡ç†å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚å¯ä»¥å°†==**ä¼šè¯**è§†ä¸º Director ä¸º*æ¯ä¸ªå•ç‹¬ç”¨æˆ·*å‡†å¤‡çš„"å¯¹è¯æ—¥å¿—"==ã€‚æ¯æ¬¡ç”¨æˆ·ä¸ Director äº¤äº’æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ä¼šè¯ï¼ˆæˆ–æ£€ç´¢ç°æœ‰ä¼šè¯ï¼‰ã€‚ç„¶åï¼Œæ­¤ä¼šè¯ä¼šä¿ç•™å‘ç”Ÿçš„æ‰€æœ‰äº‹æƒ…çš„å®Œæ•´è®°å½•ï¼š

*   **ç”¨æˆ·è¯´äº†ä»€ä¹ˆï¼š** æˆ‘ä»¬çš„é—®é¢˜ã€å‘½ä»¤å’Œè¾“å…¥ã€‚
*   **Director çš„å“åº”ï¼š** ç­”æ¡ˆã€ä¿¡æ¯å’Œå†…å®¹ï¼ˆå¦‚è§†é¢‘ IDï¼‰ã€‚
*   **å†…éƒ¨é‡‡å–çš„æ“ä½œï¼š** Director çš„æƒ³æ³•ã€è®¡åˆ’å’Œä½¿ç”¨çš„å·¥å…·ã€‚

è¿™ç§"è®°å¿†"è‡³å…³é‡è¦ï¼Œå®ƒä½¿ Director èƒ½å¤Ÿï¼š

*   **ç†è§£æŒç»­çš„ä¸Šä¸‹æ–‡ï¼š** çŸ¥é“"é‚£ä¸ª"æŒ‡çš„æ˜¯ä¹‹å‰æ˜¾ç¤ºçš„çŒ«å’ªè§†é¢‘ã€‚
*   **å¼•ç”¨å…ˆå‰çš„è¾“å‡ºï¼š** ä½¿ç”¨æ—©æœŸæ­¥éª¤ä¸­çš„è§†é¢‘ IDï¼Œè€Œæ— éœ€æˆ‘ä»¬é‡å¤å®ƒã€‚
*   **ç»´æŒè¿ç»­ã€è¿è´¯çš„å¯¹è¯ï¼š** ä½¿äº¤äº’æ„Ÿè§‰è‡ªç„¶å’Œæ™ºèƒ½ã€‚

## æˆ‘ä»¬çš„ç”¨ä¾‹ï¼šè¿è´¯çš„è§†é¢‘æœç´¢

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ç”¨ä¾‹æ¥çªå‡ºä¼šè¯ç®¡ç†çš„å¼ºå¤§åŠŸèƒ½ï¼š

1.  **ç”¨æˆ·è¯¢é—®ï¼š** "ç»™æˆ‘æ‰¾ä¸€ä¸ªå…³äºå°ç‹—çš„è§†é¢‘ã€‚"
2.  **Director å“åº”ï¼š** "è¿™æ˜¯ä¸€ä¸ªå¯çˆ±çš„å°ç‹—è§†é¢‘ï¼"ï¼ˆå¹¶åœ¨å†…éƒ¨è®°å½•å…¶å”¯ä¸€ IDï¼Œæ¯”å¦‚è¯´ `puppy_video_123`ï¼‰ã€‚
3.  **ç”¨æˆ·æå‡ºåç»­é—®é¢˜ï¼š** "*é‚£ä¸ª*è§†é¢‘çš„æ—¶é•¿æ˜¯å¤šå°‘ï¼Ÿ"

å¦‚æœæ²¡æœ‰ä¼šè¯ç®¡ç†ï¼ŒDirector ä¸ä¼šçŸ¥é“"é‚£ä¸ªè§†é¢‘"æŒ‡çš„æ˜¯å“ªä¸ªè§†é¢‘ã€‚==æœ‰äº†å®ƒï¼ŒDirector å›é¡¾ä¼šè¯çš„è®°å¿†ï¼Œçœ‹åˆ°åˆšæ‰æåˆ°äº† `puppy_video_123`ï¼Œå°±å¯ä»¥æ­£ç¡®å›ç­”==ã€‚

## `Session` ç±»ï¼šæˆ‘ä»¬çš„å¯¹è¯ä¸­å¿ƒ

åœ¨ Director é¡¹ç›®ä¸­ï¼Œ`Session` ç±»æ˜¯ç®¡ç†æ­¤å¯¹è¯æ—¥å¿—çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒåœ¨ `backend/director/core/session.py` ä¸­å®šä¹‰ã€‚

### åˆ›å»ºæ–°ä¼šè¯

> å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡å¼€å§‹ä¸ Director äº¤äº’æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ `Session`ã€‚è¿™å°±åƒä¸ºæ–°å¯¹è¯æ‰“å¼€ä¸€æœ¬æ–°çš„æ—¥å¿—ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç¤ºä¾‹ï¼š

```python
from director.core.session import Session
from director.db.sqlite.db import SQLiteDB # ä¸ºç®€å•èµ·è§ä½¿ç”¨ SQLite

# é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“è¿æ¥
# åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™å°†è¢«æ­£ç¡®åˆå§‹åŒ–ã€‚
db_connection = SQLiteDB(db_path=":memory:") # ç¤ºä¾‹ä¸­ä½¿ç”¨å†…å­˜æ•°æ®åº“

# å‡è®¾ç”¨æˆ·åˆšå¼€å§‹èŠå¤©ï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ ID
user_session_id = "user-123-abc"
user_conversation_id = "conv-456-def"

# ä¸ºæ­¤ç”¨æˆ·åˆ›å»ºæ–°ä¼šè¯
my_session = Session(
    db=db_connection,
    session_id=user_session_id,
    conv_id=user_conversation_id,
    video_id=None, # è¿˜æ²¡æœ‰ç‰¹å®šè§†é¢‘
    collection_id=None, # è¿˜æ²¡æœ‰ç‰¹å®šé›†åˆ
)
my_session.create() # å°†æ­¤æ–°ä¼šè¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­

print(f"New session created with ID: {my_session.session_id}")
# è¾“å‡ºï¼šNew session created with ID: user-123-abc
```

**è§£é‡Šï¼š**
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº† `Session` ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚

- æˆ‘ä»¬ä¸ºå®ƒæä¾›æ•°æ®åº“è¿æ¥ï¼ˆ`db`ï¼‰ã€å”¯ä¸€çš„ `session_id`ï¼ˆç”¨äºè¯†åˆ«*æ­¤ç‰¹å®šç”¨æˆ·çš„æ•´ä¸ªäº¤äº’å†å²*ï¼‰å’Œ `conv_id`ï¼ˆç”¨äº*æ­¤ç‰¹å®šè½®å¯¹è¯*ï¼‰ã€‚

- ç„¶åï¼Œ`create()` æ–¹æ³•å°†æ­¤æ–°ä¼šè¯è®°å½•ä¿å­˜åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ä¸­ã€‚

### å‘ä¼šè¯æ·»åŠ æ¶ˆæ¯

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„ç”¨ä¾‹ã€‚

ç”¨æˆ·é—®ï¼š"ç»™æˆ‘æ‰¾ä¸€ä¸ªå…³äºå°ç‹—çš„è§†é¢‘ã€‚"è¿™æ˜¯ä¸€ä¸ª**è¾“å…¥æ¶ˆæ¯**ã€‚Director æ‰¾åˆ°ä¸€ä¸ªè§†é¢‘å¹¶å“åº”ï¼š"è¿™æ˜¯ä¸€ä¸ªå¯çˆ±çš„å°ç‹—è§†é¢‘ï¼"è¿™æ˜¯ä¸€ä¸ª**è¾“å‡ºæ¶ˆæ¯**ã€‚è¿™==ä¸¤è€…éƒ½éœ€è¦å­˜å‚¨åœ¨ä¼šè¯çš„æ—¥å¿—ä¸­==ã€‚

`Session` ç±»æœ‰ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹æ³• `new_message` æ¥å¸®åŠ©åˆ›å»ºè¿™äº›ï¼š

```python
from director.core.session import MsgType, TextContent

# ...ï¼ˆä¸Šé¢çš„ my_session è®¾ç½®ï¼‰...

# 1. ç”¨æˆ·è¯¢é—®ï¼š"ç»™æˆ‘æ‰¾ä¸€ä¸ªå…³äºå°ç‹—çš„è§†é¢‘ã€‚"
user_input_msg = my_session.new_message(
    msg_type=MsgType.input,
    content=[TextContent(text="Find me a video about puppies.").model_dump()]
)
user_input_msg.publish() # ä¿å­˜ç”¨æˆ·çš„æ¶ˆæ¯

print(f"User input saved: '{user_input_msg.content[0]['text']}'")
# è¾“å‡ºï¼šUser input saved: 'Find me a video about puppies.'

# 2. Director å“åº”ï¼ˆå‡è®¾å®ƒæ‰¾åˆ°äº† 'puppy_video_123'ï¼‰
director_output_msg = my_session.new_message(
    msg_type=MsgType.output,
    content=[TextContent(text="Here's a cute puppy video!").model_dump()]
)
director_output_msg.publish() # ä¿å­˜ Director çš„å“åº”

print(f"Director output saved: '{director_output_msg.content[0]['text']}'")
# è¾“å‡ºï¼šDirector output saved: 'Here's a cute puppy video!'

# é‡è¦çš„æ˜¯ï¼ŒDirector ç³»ç»Ÿè¿˜ä¼šå­˜å‚¨ video_id
# ä»¥ä¾¿ç¨åå¯ä»¥å¼•ç”¨å®ƒã€‚å½“æˆ‘ä»¬è®¨è®º
# [æ¨ç†å¼•æ“](03_reasoning_engine_.md)æ—¶ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°ä»‹ç»è¿™ä¸€ç‚¹ã€‚
```

**è§£é‡Šï¼š**
æˆ‘ä»¬ä½¿ç”¨ `my_session.new_message()` åˆ›å»º `InputMessage` å’Œ `OutputMessage` å¯¹è±¡

> ==è¿™äº›å¯¹è±¡ä¼šè‡ªåŠ¨é“¾æ¥åˆ°æˆ‘ä»¬çš„ `session_id` å’Œ `conv_id`==ã€‚ç„¶åï¼Œ`.publish()` æ–¹æ³•å°†è¿™äº›æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­çš„å¯¹è¯å†å²ä¸­ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« [æ¶ˆæ¯ç±»ï¼ˆè¾“å…¥/è¾“å‡ºï¼‰](02_message_classes__input_output__.md)ä¸­è¯¦ç»†äº†è§£ `InputMessage` å’Œ `OutputMessage` åŠå…¶ `TextContent`ã€‚

### æ£€ç´¢ä¼šè¯å†å²

ç°åœ¨æ˜¯é­”æ³•æ—¶åˆ»

å½“ç”¨æˆ·é—®"*é‚£ä¸ª*è§†é¢‘çš„æ—¶é•¿æ˜¯å¤šå°‘ï¼Ÿ"æ—¶ï¼Œ==Director éœ€è¦å›å¿†ä¹‹å‰çš„äº¤äº’ã€‚`Session` ç±»å…è®¸æˆ‘ä»¬è·å–æ•´ä¸ªå¯¹è¯å†å²==ã€‚

```python
# ...ï¼ˆä¸Šé¢çš„ my_session å’Œæ¶ˆæ¯è®¾ç½®ï¼‰...

# è·å–ä¸æ­¤ä¼šè¯å…³è”çš„æ‰€æœ‰å¯¹è¯
conversation_history = my_session.db.get_conversations(my_session.session_id)

print("\n--- Full Conversation History ---")
for msg in conversation_history:
    sender = "User" if msg['msg_type'] == 'input' else "Director"
    print(f"{sender}: {msg['content'][0]['text']}")

# è¾“å‡ºï¼š
# --- Full Conversation History ---
# User: Find me a video about puppies.
# Director: Here's a cute puppy video!
```

**è§£é‡Šï¼š**
é€šè¿‡è°ƒç”¨ `my_session.db.get_conversations(my_session.session_id)`ï¼ŒDirector å¯ä»¥æ£€ç´¢ä¸å½“å‰ä¼šè¯å…³è”çš„æ‰€æœ‰æ¶ˆæ¯ã€‚è¿™ä½¿å®ƒèƒ½å¤Ÿ"è®°ä½"ä¸Šä¸‹æ–‡ï¼Œå¦‚ä¹‹å‰æåˆ°çš„å°ç‹—è§†é¢‘ï¼Œå¹¶è¿è´¯åœ°å›ç­”åç»­é—®é¢˜ã€‚

é™¤äº†å¯¹è¯ä¹‹å¤–ï¼Œä¼šè¯è¿˜å­˜å‚¨ `reasoning_context`ï¼Œè¿™æ˜¯ Director é‡‡å–çš„å†…éƒ¨æƒ³æ³•å’Œæ­¥éª¤ã€‚

è¿™å°±åƒ Director çš„è‰ç¨¿æœ¬ï¼Œå¸®åŠ©å®ƒå›å¿†*ä¸ºä»€ä¹ˆ*åšæŸäº‹ï¼Œè€Œä¸ä»…ä»…æ˜¯*è¯´äº†ä»€ä¹ˆ*ã€‚==`Session` ç±»ä¹Ÿå¤„ç†ä¿å­˜å’Œæ£€ç´¢è¿™äº› `ContextMessage` å¯¹è±¡==ã€‚

## ğŸ¢åº•å±‚åŸç†ï¼šDirector å¦‚ä½•è®°å¿†

è®©æˆ‘ä»¬çœ‹çœ‹ Director ç®¡ç†ä¼šè¯æ—¶å¹•åå‘ç”Ÿäº†ä»€ä¹ˆã€‚

### å¸¦æœ‰ä¼šè¯ç®¡ç†çš„å¯¹è¯æµç¨‹

å½“æˆ‘ä»¬ä¸ Director äº¤äº’æ—¶ï¼Œä»¥ä¸‹æ˜¯ç®€åŒ–çš„äº‹ä»¶åºåˆ—ï¼š

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant DirectorApp as Director åº”ç”¨ç¨‹åº
    participant Session as ä¼šè¯é€»è¾‘
    participant Database as æ•°æ®åº“ï¼ˆSQLite/Postgresï¼‰

    User->>DirectorApp: "ç»™æˆ‘æ‰¾ä¸€ä¸ªå…³äºå°ç‹—çš„è§†é¢‘ã€‚"
    DirectorApp->>Session: è·å–/åˆ›å»ºä¼šè¯ï¼ˆç”¨æˆ· IDï¼‰
    Session->>Database: æ£€æŸ¥ç°æœ‰ä¼šè¯
    Database-->>Session: è¿”å›ä¼šè¯æ•°æ®ï¼ˆæˆ–ç©ºï¼‰
    Session-->>DirectorApp: æä¾› Session å¯¹è±¡

    DirectorApp->>Session: åˆ›å»º InputMessage
    Session->>Session: ç”¨ session_idã€conv_id å¡«å……æ¶ˆæ¯
    Session->>Database: å°† InputMessage ä¿å­˜åˆ° 'conversations' è¡¨
    Database-->>Session: ç¡®è®¤

    Note over DirectorApp: Director å¤„ç†è¯·æ±‚ï¼Œæ‰¾åˆ°è§†é¢‘ï¼Œè®¡åˆ’å“åº”ã€‚
    DirectorApp->>Session: åˆ›å»º OutputMessageï¼ˆå¸¦æœ‰è§†é¢‘ä¿¡æ¯ï¼‰
    Session->>Session: ç”¨ session_idã€conv_id å¡«å……æ¶ˆæ¯
    Session->>Database: å°† OutputMessage ä¿å­˜åˆ° 'conversations' è¡¨
    Database-->>Session: ç¡®è®¤

    Note over DirectorApp: Director å¯èƒ½è¿˜ä¼šä¿å­˜å†…éƒ¨æƒ³æ³•ã€‚
    DirectorApp->>Session: ä¿å­˜æ¨ç†ä¸Šä¸‹æ–‡ï¼ˆContextMessageï¼‰
    Session->>Database: å°† ContextMessage ä¿å­˜åˆ° 'context_messages' è¡¨
    Database-->>Session: ç¡®è®¤

    Session-->>DirectorApp: è¿”å› OutputMessage
    DirectorApp->>User: "è¿™æ˜¯ä¸€ä¸ªå¯çˆ±çš„å°ç‹—è§†é¢‘ï¼"

    User->>DirectorApp: "é‚£ä¸ªè§†é¢‘çš„æ—¶é•¿æ˜¯å¤šå°‘ï¼Ÿ"
    DirectorApp->>Session: è·å–ä¼šè¯ï¼ˆç”¨æˆ· IDï¼‰
    Session->>Database: æ£€ç´¢ä¼šè¯ã€å¯¹è¯ã€ä¸Šä¸‹æ–‡
    Database-->>Session: è¿”å›æ‰€æœ‰ç›¸å…³æ•°æ®
    Session-->>DirectorApp: æä¾›ä¸°å¯Œçš„ Session å¯¹è±¡

    Note over DirectorApp: Director ç°åœ¨æ‹¥æœ‰å®Œæ•´çš„è®°å¿†æ¥å›ç­”åç»­é—®é¢˜ã€‚
```

### æ•°æ®åº“äº¤äº’ï¼šè®°å¿†åº“

`Session` ç±»ä¸¥é‡ä¾èµ–æ•°æ®åº“æ¥å­˜å‚¨æ‰€æœ‰è¿™äº›ä¿¡æ¯ã€‚Director è®¾è®¡çµæ´»ï¼Œæ”¯æŒä¸åŒçš„æ•°æ®åº“ï¼Œå¦‚ SQLite æˆ– PostgreSQLã€‚è¿™é€šè¿‡ä¸€ä¸ªåä¸º `BaseDB` çš„æ¥å£è¿›è¡Œç®¡ç†ï¼Œå®ƒå……å½“ä»»ä½•æ•°æ®åº“åº”å¦‚ä½•å­˜å‚¨å’Œæ£€ç´¢ä¼šè¯æ•°æ®çš„è“å›¾ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹æ•°æ®åº“å®ç°ï¼ˆ`backend/director/db/sqlite/db.py` æˆ– `backend/director/db/postgres/db.py`ï¼‰ä¸­çš„ä¸€äº›ç®€åŒ–ä»£ç ç‰‡æ®µï¼Œäº†è§£ä¼šè¯å’Œæ¶ˆæ¯æ˜¯å¦‚ä½•å­˜å‚¨çš„ã€‚

#### 1. åˆ›å»ºä¼šè¯ï¼ˆ`create_session`ï¼‰

å½“è°ƒç”¨ `my_session.create()` æ—¶ï¼Œå®ƒä¼šè§¦å‘åº•å±‚æ•°æ®åº“ä¸­çš„ `create_session` æ–¹æ³•ï¼š

```python
# æ¥è‡ª backend/director/db/sqlite/db.pyï¼ˆç®€åŒ–ï¼‰
class SQLiteDB(BaseDB):
    def create_session(
        self,
        session_id: str,
        video_id: str, # æœ€åˆå¯èƒ½æ˜¯ None
        collection_id: str, # æœ€åˆå¯èƒ½æ˜¯ None
        created_at: int = None,
        updated_at: int = None,
        metadata: dict = {},
        **kwargs,
    ) -> None:
        self.cursor.execute(
            """
        INSERT OR IGNORE INTO sessions (session_id, video_id, collection_id, created_at, updated_at, metadata)
        VALUES (?, ?, ?, ?, ?, ?)
        """,
            (session_id, video_id, collection_id, created_at, updated_at, json.dumps(metadata)),
        )
        self.conn.commit()
```

**è§£é‡Šï¼š**
æ­¤ä»£ç åœ¨ `sessions` è¡¨ä¸­æ’å…¥ä¸€è¡Œæ–°è®°å½•ã€‚å®ƒç¡®ä¿æ¯ä¸ª `session_id` æ˜¯å”¯ä¸€çš„ï¼ˆ`INSERT OR IGNORE`ï¼‰ã€‚æ­¤è®°å½•æ˜¯æˆ‘ä»¬å¯¹è¯æ—¥å¿—çš„åŸºç¡€ã€‚

#### 2. å­˜å‚¨å¯¹è¯æ¶ˆæ¯ï¼ˆ`add_or_update_msg_to_conv`ï¼‰

å½“è°ƒç”¨ `user_input_msg.publish()` æˆ– `director_output_msg.publish()` æ—¶ï¼Œå®ƒä½¿ç”¨ `add_or_update_msg_to_conv` æ–¹æ³•ï¼š

```python
# æ¥è‡ª backend/director/db/sqlite/db.pyï¼ˆç®€åŒ–ï¼‰
class SQLiteDB(BaseDB):
    def add_or_update_msg_to_conv(
        self,
        session_id: str,
        conv_id: str,
        msg_id: str,
        msg_type: str,
        agents: List[str],
        actions: List[str],
        content: List[dict],
        status: str = None,
        created_at: int = None,
        updated_at: int = None,
        metadata: dict = {},
        **kwargs,
    ) -> None:
        self.cursor.execute(
            """
        INSERT OR REPLACE INTO conversations (session_id, conv_id, msg_id, msg_type, agents, actions, content, status, created_at, updated_at, metadata)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """,
            (
                session_id, conv_id, msg_id, msg_type,
                json.dumps(agents), json.dumps(actions), json.dumps(content),
                status, created_at, updated_at, json.dumps(metadata),
            ),
        )
        self.conn.commit()
```

**è§£é‡Šï¼š**
æ­¤æ–¹æ³•å°†æ¯æ¡å•ç‹¬çš„æ¶ˆæ¯ï¼ˆç”¨æˆ·è¾“å…¥å’Œ Director è¾“å‡ºï¼‰å­˜å‚¨åˆ° `conversations` è¡¨ä¸­ã€‚

æ¯æ¡æ¶ˆæ¯éƒ½é“¾æ¥åˆ°å…¶ `session_id` å’Œ `conv_id`ã€‚`INSERT OR REPLACE` ç¡®ä¿å¦‚æœå…·æœ‰ç›¸åŒ `msg_id` çš„æ¶ˆæ¯å·²ç»å­˜åœ¨ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ Director æ›´æ–°æ­£åœ¨è¿›è¡Œçš„æ¶ˆæ¯çš„çŠ¶æ€ï¼‰ï¼Œå®ƒä¼šè¢«æ›´æ–°è€Œä¸æ˜¯åˆ›å»ºé‡å¤é¡¹ã€‚

#### 3. å­˜å‚¨æ¨ç†ä¸Šä¸‹æ–‡ï¼ˆ`add_or_update_context_msg`ï¼‰

Director è¿˜ä¿å­˜å…¶å†…éƒ¨"æƒ³æ³•"æˆ–"æ¨ç†ä¸Šä¸‹æ–‡"ï¼Œè¿™æœ‰åŠ©äºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ç†è§£æ­£åœ¨è¿›è¡Œçš„äº¤äº’ã€‚

```python
# æ¥è‡ª backend/director/db/sqlite/db.pyï¼ˆç®€åŒ–ï¼‰
class SQLiteDB(BaseDB):
    def add_or_update_context_msg(
        self,
        session_id: str,
        context_messages: list, # æ­¤åˆ—è¡¨åŒ…å« ContextMessage å¯¹è±¡
        created_at: int = None,
        updated_at: int = None,
        metadata: dict = {},
        **kwargs,
    ) -> None:
        self.cursor.execute(
            """
        INSERT OR REPLACE INTO context_messages (context_data, session_id, created_at, updated_at, metadata)
        VALUES (?, ?, ?, ?, ?)
        """,
            (
                json.dumps(context_messages), # ä¸Šä¸‹æ–‡æ¶ˆæ¯å­˜å‚¨ä¸º JSON
                session_id,
                created_at,
                updated_at,
                json.dumps(metadata),
            ),
        )
        self.conn.commit()
```

**è§£é‡Šï¼š**
è¿™å°† `ContextMessage` å¯¹è±¡åˆ—è¡¨ï¼ˆå³ Director çš„å†…éƒ¨æ¨ç†æ­¥éª¤ï¼‰å­˜å‚¨åœ¨ `context_messages` è¡¨ä¸­ï¼Œä¹Ÿé“¾æ¥åˆ° `session_id`ã€‚

è¿™ä½¿ Director çš„æ¨ç†å¼•æ“èƒ½å¤Ÿå‡†ç¡®åœ°ä»ä¸Šæ¬¡åœæ­¢çš„åœ°æ–¹ç»§ç»­ï¼Œå³ä½¿è·¨å¤šä¸ªè¯·æ±‚ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

## ç»“è®º

ä¼šè¯ç®¡ç†æ˜¯æ„å»ºåƒ Director è¿™æ ·çš„æ™ºèƒ½å¯¹è¯å¼ AI ç³»ç»Ÿçš„åŸºçŸ³ã€‚é€šè¿‡å°†æ¯æ¬¡ç”¨æˆ·äº¤äº’è§†ä¸ºæ­£åœ¨è¿›è¡Œçš„ `Session` çš„ä¸€éƒ¨åˆ†ï¼ŒDirector è·å¾—äº†å¼ºå¤§çš„è®°å¿†åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿç†è§£ä¸Šä¸‹æ–‡ã€å›å¿†è¿‡å»çš„ä¿¡æ¯å¹¶ç»´æŒçœŸæ­£è¿è´¯çš„å¯¹è¯ã€‚

è¿™ä¸ª"å¯¹è¯æ—¥å¿—"å¯¹äºä½¿äº¤äº’æ„Ÿè§‰è‡ªç„¶å’Œé«˜æ•ˆè‡³å…³é‡è¦ã€‚

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»”ç»†ç ”ç©¶å­˜å‚¨åœ¨è¿™äº›ä¼šè¯ä¸­çš„å®é™…æ•°æ®ï¼š`InputMessage` å’Œ `OutputMessage` ç±»ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•è¡¨ç¤ºç”¨æˆ·æ‰€è¯´çš„å†…å®¹å’Œ Director çš„å“åº”ã€‚

[ä¸‹ä¸€ç« ï¼šæ¶ˆæ¯ç±»ï¼ˆè¾“å…¥/è¾“å‡ºï¼‰](02_message_classes__input_output__.md)

